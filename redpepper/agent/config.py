"""RedPepper Manager configuration"""

import glob
import secrets

import yaml

DEFAULT_CONFIG_FILE = "/etc/redpepper/agent.yml"
MACHINE_ID_FILE = "/etc/redpepper/machine_id"

defaults = {
    "auth_secret": "",
    "data_request_timeout": 5,
    "hello_timeout": 3,
    "include": ["/etc/redpepper/agent.d/*.yml"],
    "manager_host": "localhost",
    "manager_port": 7051,
    "machine_id": None,
    "ping_interval": 30,
    "ping_timeout": 5,
    "states_dir": "/var/lib/redpepper-agent/states",
    "tls_ca_file": None,
    "tls_ca_path": None,
    "tls_ca_data": None,
    "tls_check_hostname": True,
    "tls_verify_mode": "required",
}


def load_agent_config(config_file=None, machine_id_file=None):
    if config_file is None:
        config_file = DEFAULT_CONFIG_FILE
    try:
        with open(config_file, "r") as stream:
            yml = yaml.safe_load(stream)
    except FileNotFoundError:
        yml = {}
    conf = defaults.copy()
    conf.update(yml)
    process_includes(conf, [config_file])
    if machine_id_file is None:
        machine_id_file = MACHINE_ID_FILE
    try:
        with open(machine_id_file, "r") as mf:
            machine_id = mf.read().strip()
    except FileNotFoundError:
        pass
    else:
        conf["machine_id"] = machine_id
    if not conf["machine_id"]:
        conf["machine_id"] = "autogenerated " + secrets.token_hex(8)
    return conf


def process_includes(conf, included_files):
    if "include" not in conf:
        return
    for pattern in conf["include"]:
        for filename in glob.glob(pattern):
            if filename in included_files:
                continue
            included_files.append(filename)
            with open(filename, "r") as stream:
                included_yml = yaml.safe_load(stream)
            conf.update(included_yml)
            process_includes(included_yml, included_files)
